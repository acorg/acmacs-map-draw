#! /usr/bin/env python3
# -*- Python -*-

"""
"""

import sys, os, traceback, pprint
if sys.version_info.major != 3: raise RuntimeError("Run script with python3")
from pathlib import Path
sys.path[:0] = [str(Path(os.environ["ACMACSD_ROOT"]).resolve().joinpath("py"))]
import logging; module_logger = logging.getLogger(__name__)

import acmacs_map_draw
from acmacs_base.timeit import timeit
from acmacs_base.json import read_json, write_json

# ----------------------------------------------------------------------

def main(args):
    if not Path(args.chart[0]).exists():
        raise RuntimeError("File not found: " + args.chart[0])
    with timeit("Reading chart from " + args.chart[0]):
        chart = acmacs_map_draw.import_chart(args.chart[0])
    settings = sSettings
    if args.settings:
        settings_file = Path(args.settings)
        if settings_file.exists():
            settings = read_json(settings_file)
        else:
            write_json(path=settings_file, data=settings)
    with timeit("Drawing chart to " + args.output[0]):
        try:
            acmacs_map_draw.draw_chart(output_file=args.output[0], chart=chart, settings=settings, output_width=args.output_width, verbose=args.verbose)
        except acmacs_map_draw.UnrecognizedMod as err:
            if args.verbose:
                raise
            module_logger.error('Unrecognized mod: {} (-v to get details)'.format(repr(err.args[0])))
            return 1

# ----------------------------------------------------------------------

sSettings = {
    "mods": [
        # "flip_ew",
        # {"N": "rotate_degrees", "angle": -20},
        "egg", "reassortant",
        "all_grey",
        {"N": "title", "?display_name": ["1", "2"], "text_size": 12, "background": "#F0F0FF", "border_color": "black", "border_width": 0.1},
        # {"N": "aa_substitutions", "positions": [158, 159], "legend": {"show": True, "offset": [-10, -10], "point_count": True, "background": "grey99", "border_color": "black", "border_width": 0.1, "label_size": 12, "point_size": 8}},
        # {"N": "clades", "legend": {"show": True, "offset": [-10, -10], "point_count": True, "background": "grey99", "border_color": "black", "border_width": 0.1, "label_size": 12, "point_size": 8}},
        {"N": "vaccines", "size": 15}
        # {"N": "vaccines", "size": 15, "label": {
        #     "": {"offset": [0, 1], "color": "black", "size": 12, "name_type": "abbreviated_with_passage_type"},
        #     "current-reassortant": {"offset": [1, 0]},
        #     "current-cell": {"offset": [-1, 1]},
        #     }
        # },
        ],
    "mods?": [
        "flip_ns", "flip_ew", {"N": "flip", "value": [-1, 1]},
        {"N": "rotate_degrees", "angle": 30}, {"N": "rotate_radians", "angle": -1},
        {"N": "viewport", "value": [-6, -6, 10]},
        "egg", "reassortant", "all_grey",
        {},
        {"N": "antigens", "select": "?", "fill": "blue4", "outline": "red", "raise_": True, "report_names_threshold": 10,
             "?select_variants": [
                 {"name": "NEBRASKA/4/"},
                 "reference", "test", "all", {"date_range": ["2010-01-01", ""]}, {"older_than_days": 365}, {"younger_than_days": 365},
                 {"passage_type": "egg"}, {"passage_type": "cell"}, {"passage_type": "reassortant"},
                 {"country": "GERMANY"}, {"continent": "NORTH-AMERICA"}
                 ]},
        {"N": "sera", "select": "all", "outline": "cyan3", "raise_": True, "report_names_threshold": 10,
             "?select_variants": [
                 {"name": "NEBRASKA/4/"},
                 "all"
                 ]},
        {"N": "continents", "legend": {"show": False, "offset": [-1, -1], "size": 100}},
        {"N": "clades", "legend": {"show": True, "offset": [-10, -10], "point_count": True, "background": "grey99", "border_color": "black", "border_width": 0.1, "label_size": 12, "point_size": 8}},
        {"N": "aa_substitutions", "positions": [159], "legend": {"show": True, "offset": [-10, -10], "point_count": True, "background": "grey99", "border_color": "black", "border_width": 0.1, "label_size": 12, "point_size": 8}},
        {"N": "vaccines", "size": 15},
        {"N": "vaccines", "size": 15, "label": {
            "": {"offset": [0, 1], "color": "black", "size": 12, "name_type": "abbreviated_with_passage_type", "?": "default values for all vaccines"},
            "current-egg": {},
            "current-cell": {},
            "current-reassortant": {},
            "previous-egg": {},
            "previous-cell": {},
            "previous-reassortant": {},
            "surrogate-egg": {},
            "surrogate-cell": {},
            "surrogate-reassortant": {},
        }},
        {},
        {"N": "style", "index": 0, "fill": "red", "outline": "green", "show": True, "shape": "triangle", "size": 10, "outline_width": 1, "aspect": 1, "rotation": 0, "raise_": True, "lower": None},
        {"N": "style", "index": [1,2,3], "fill": "red", "outline": "green", "show": True, "shape": "triangle", "size": 10, "outline_width": 1, "aspect": 1, "rotation": 0, "raise_": True, "lower": None},
        {},
        {"N": "title", "text_size": 12, "background": "#F0F0FF", "border_color": "black", "border_width": 0.1},
        {"N": "title", "display_name": ["T", "X"], "text_size": 12, "background": "#F0F0FF", "border_color": "black", "border_width": 0.1},
        {"N": "point_scale", "scale": 1, "outline_scale": 1},
        {"N": "background", "color": "white"},
        {"N": "grid", "color": "grey80", "line_width": 1},
        {"N": "border", "color": "black", "line_width": 1},
        ],
    }

# ----------------------------------------------------------------------

try:
    import argparse
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('-d', '--debug', action='store_const', dest='loglevel', const=logging.DEBUG, default=logging.INFO, help='Enable debugging output.')

    # parser.add_argument('--hidb-dir', action='store', dest='hidb_dir', default="~/AD/data", help='Directory with hidb4.*.json.xz.')
    parser.add_argument('--output-size', action='store', dest='output_width', default=600, help='Width of the output image.')
    parser.add_argument('-v', '--verbose', action='store_true', dest='verbose', default=False)
    parser.add_argument('-s', '--settings', action='store', dest='settings', default=None, help='Settings file. Autocreated, if does not exist.')

    parser.add_argument('chart', nargs=1, help='Chart file.')
    parser.add_argument('output', nargs=1, help='Output pdf file.')

    args = parser.parse_args()
    logging.basicConfig(level=args.loglevel, format="%(levelname)s %(asctime)s: %(message)s")
    exit_code = main(args)
except Exception as err:
    logging.error('{}\n{}'.format(err, traceback.format_exc()))
    exit_code = 1
exit(exit_code)

# ======================================================================
### Local Variables:
### eval: (if (fboundp 'eu-rename-buffer) (eu-rename-buffer))
### End:
