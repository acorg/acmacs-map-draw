# Time-stamp: <2020-05-31 09:28:56 eu>

* Common usage

mapi chart.ace output.pdf -- plot spec stored in chart
mapi chart.ace output.pdf -a //clades -- by clade
mapi primary.ace secondary.ace output.pdf -a /pc -- procrustes
mapi primary.ace secondary.ace output.pdf -a //clades,/pc -- color by clade and procrustes
mapi -i -s draw.json chart.ace output.pdf -- interactive

* Command line defines

-D lab=CDC
-D virus-type=H3
-D "virus-type=A(H3N2)"

* Substitutions inferred from a (primary) chart

{virus}                       ""
{virus-type}                  "A(H3N2)"
{lineage}                     "VICTORIA"
{virus-type/lineage}          "B/Vic"
{subset}                      "2009pdm"
{lab}                         "VIDRL" "Crick"
{table-date}                  "20150101-20200203"
{assay}                       "hi" "neut"
{assay-full}                  "HI" "PLAQUE REDUCTION NEUTRALISATION"
{rbc}                         "guinea-pig"
{number-of-antigens}          2838
{number-of-sera}              105
{number-of-layers}            115
{primary-chart-name}          "/path/chart.ace"
{secondary-chart-name}        "/path/chart.ace"

To print environment use:
-a :print-all-environment

* Select Antigens

#+BEGIN_SRC json
  {"name": "SWITZERLAND/9715293/2013", "passage": "reassortant"} -- multiple keys means all must match (conjunction)

  "none"
  null -- means "all"
  "all"
  "reference"
  {"reference": true} -- to combine with other criteria
  "test"
  {"test": true} -- to combine with other criteria

  {"index": 11}
  {"index": [55, 66]} -- disjunction
  {"indexes": [55, 66]} -- DEPRECATED

  {"name": "SWITZERLAND/9715293/2013"}
  {"name": "~/971529\d/"} -- regex search in FULL name (~ in front removed before compiling regex, use single \)
  {"name": ["SWITZERLAND/9715293/2013", "~/2/2009"]} -- either matched (disjunction)

  "egg" -- wildtype only
  "cell"
  "reassortant"
  {"passage": "egg"} -- wildtype only, lowercase! "EGG" means exact passage
  {"passage": "cell"}
  {"passage": "reassortant"}
  {"passage": ["egg", "reassortant"]} -- either wildtype or reassortant (disjunction)
  {"passage": "E4"} -- search in passage
  {"passage": "~E\d$"} -- regex search (~ in front removed before compiling regex, use single \)
  {"passage": ["E4", "~K\d$"]} -- combine non-regex and regex search (disjunction)

  {"date": ["2016-01-01", "2016-09-01"]} -- range
  {"date": ["", "2016-09-01"]}
  {"date": ["2016-01-01", ""]}
  {"date": {"older-than-days": 365}}
  {"date": {"younger-than-days": 365}}
  {"date": {"older-than-days": 183, "younger-than-days": 365}} -- (conjunction)
  {"date": {"before": "2016-09-01"}}
  {"date": {"after": "2016-09-01"}}
  {"date": {"after": "2016-09-01", "older-than-days": 183}} -- (conjunction)

  {"country": "sweden"} -- case insensetive
  {"country": ["sweden", "norway"]} -- disjunction
  {"continent": "europe"} -- case insensetive
  {"continent": ["europe", "russia"]} -- disjunction
  {"localtion": "HONG KONG"}
  {"localtion": ["HONG KONG", "CHINA"]} -- disjunction

  {"sequenced": true}, {"sequenced": false}
  {"clade": "3C.3A"} -- ~/AD/share/conf/clades.json
  {"clade": ["3C.3A", "3C.2A2"]} -- disjunction
  {"amino-acid": "144R"}
  {"amino-acid": ["144R", "93A", "!160K"]} -- conjunction
  # sort aa at pos by frequency and set ana/google colors, X is always grey

  {"lab": "CDC"}
  {"lab": ["CDC", "MELB"]} -- disjunction
  {"lab": ["CDC", "VIDRL"]} -- old and new lab name

  # {"subtype": "H1 A(H1N1) H3 A(H3N2) B BV BVIC BY BYAM"}, --?
  {"lineage": "VICTORIA"} -- chart lineage (NOT each antigen lineage)
  {"lineage": "VIC"}
  {"lineage": "V"}

  # "vaccine"
  # {"vaccine": {"type": "previous", "no": 0, "passage": "egg", "name": "SWITZERLAND"}}

  {"inside": {"points": : [<point-position>, ...]}} -- see point-position in Drawing below, path is closed
  # {"in-circle": <Circle in Drawing>}

  # {"outlier": 1.0} # threshold in units (distance from centroid of pre-selected points), must be after other select args, e.g. after "clade"

  {"table": "20170216"}
  {"table": ["20170216", "20170221"]} -- disjunction
  {"table": "MELB:HI:turkey:20170216"} -- table name is from hidb, it is not from chart layers
  {"table": ["MELB:HI:turkey:20170216", "NIID:HI:YAMAGATA:turkey:20191003.002"]} -- disjunction
  {"layer": 0} -- >=0: from the beginning, <0: from end
  {"layer": [0, -1]} -- disjunction

  # {"relative-to-serum-line": {"distance-min": 0, "distance-max": 10000, "direction": 1}, "?direction": [1, -1, 0]}

  {"titrated-against-sera": <select sera>}
  {"titrated-against": <select sera>} -- same as above
  {"not-titrated-against-sera": <select sera>}
  {"not-titrated-against": <select sera>} -- same as above

  {"fill": "red", "outline": "green", "outline-width": 3}

  {"exclude-distinct": true}

  {"report": true, "report-threshold": 20}
#+END_SRC


* Select Sera

#+BEGIN_SRC json
  "all"
  {"index": ...} -- see Antigens for variants
  {"name*": ...} -- see Antigens for variants
  {"date": ...} -- via homologous antigens
  {"country": ...}
  {"continent": ...}
  {"localtion": ...}
  {"clade": ...}  -- ? via seqdb.clades_for_name()
  {"sequenced": ...}
  {"amino-acid": ...}

  {"serum_id": "CDC 2016-003"}
  {"serum_id": "~2016"} -- regex search

  {"inside": ...}

  {"table": ...}
  {"titrated-against-antigens": <select sera>}
  {"titrated-against": <select sera>} -- same as above
  {"not-titrated-against-antigens": <select sera>}
  {"not-titrated-against": <select sera>} -- same as above

  {"fill": "red", "outline": "green", "outline-width": 3}

  {"exclude-distinct": true}

  {"report": true, "report_threshold": 20}
#+END_SRC


* Antigens and Sera

[[Select Antigens][Select Antigens]]
[[Select Sera][Select Sera]]
[[Label][Label]]

#+BEGIN_SRC json
  {"N": "antigens", "select": <Select Antigens>
   "outline": "<color-modifier>", "fill": "<color-modifier>",
   "aspect": 1.0, "rotation": 0.0, "outline_width": 1.0,
   "size": 1.0, "show": true, "shape": "circle|box|triangle",
   "order": "raise|lower",
   "label": <Label>,
   "legend": {"show": true, "label": "name ({count})", "replace": false},
   }

  {"N": "sera", "select": {<Select Sera>},
   "outline": "<color-modifier>", "fill": "<color-modifier>",
   "aspect": 1.0, "rotation": 0.0,
   "size": 1.0, "outline_width": 1.0,
   "show": true, "shape": "circle|box|triangle",
   "order": "raise|lower",
   "label": <Label>,
   "legend": {"show": true, "label": "name ({count})", "replace": false},
  }
#+END_SRC

~<Label>~
#+BEGIN_SRC json
  {"show": true,
   "format": "{name-abbreviated} <run chart-name-format-help to list formats>",
   "color": "black", "size": 12.0, "offset": [0, 1],
   "weight": "bold", "slant": "italic", "font_family": "monospace"}
#+END_SRC

~<color-modifier>~

color and color modifier 
See [[file:~/AD/share/doc/color.org][color.org]]

"fill": "red"
"fill": "red:s-0.5"

** outline and fill depends on passage

#+BEGIN_SRC json
  "fill": "passage"
  "fill": "passage:t0.8" -- with modifier
  "fill": {"egg": "#FF4040", "reassortant": "#FF4040", "cell": "#4040FF"}

  "outline": "passage"
  "outline": "passage:t0.8" -- with modifier
  "outline": {"egg": "#FF4040", "reassortant": "#FF4040", "cell": "#4040FF"}
#+END_SRC

** outline and fill depends on aa at pos

#+BEGIN_SRC json
  "fill": {"aa-at": 159}
  "fill": {"aa-at": 159, "colors": ["#FF4040", "#4040FF", "#40FF40"]} -- ordered by frequency, X is always grey

  "outline": {"aa-at": 159}
  "outline": {"aa-at": 159, "colors": ["#FF4040", "#4040FF", "#40FF40"]} -- ordered by frequency, X is always grey

  -- NOTE to change fill and make outline black for just sequenced antigens, add another entry afterwards
  {"N": "antigens", "select": {"sequenced": true}, "outline": "black"},
#+END_SRC


* Map data

#+BEGIN_SRC json
  {"N": "reset"},

  {"N": "rotate", "degrees": 30, "radians": 1, "?positive": "counter-clockwise"},
  {"N": "flip", "direction": "ew|ns"},
  {"N": "viewport", "rel": [-1, 1, -5], "?abs": [-5, -5, 10]},
  {"N": "background", "color": "white"},
  {"N": "border", "color": "black", "line_width": 1},
  {"N": "grid", "color": "grey80", "line_width": 1},
  {"N": "point-scale", "scale": 1, "outline_scale": 1},

  {"N": "export", "chart": <index, 0 by default>, "filename": "<substitute-chart-metadata> (original file overwritten by default)"}
#+END_SRC

- ~Title~
  #+BEGIN_SRC json
    {"N": "title", "show": true, "offset": [10, 10], "lines": ["Line 1 {lab} {assay} {assay_short} {virus_type} {lineage} {rbc} {subset} {date} {name}", "Line 2", "Another line"],
     "padding": 10, "background": "transparent", "border_color": "black", "border_width": 0.0, "text_color": "black", "text_size": 12, "interline": 2, "font_weight": "normal", "font_slant": "normal", "font_family": "sans serif"
    }
  #+END_SRC

- ~Legend~
  #+BEGIN_SRC json
    {
        "N": "legend",
        "offset": [-10, 10],
        "show": true,
        "label_size": 14,
        "point_size": 10,
        "title": "<format>" -- ["<format>", ...]
        "lines": [{"text": "163-del", "outline": "black", "fill": "red"}] -- additional lines added after the ones added by {"N": antigens, "legend": ...}
    }

    {
        "N": "legend",
        "type": "continent-map",
        "offset": [-10, 10],
        "show": true
    }
  #+END_SRC

- ~<substitute-chart-metadata>~
  {virus}
  {virus_type}
  {virus_type_lineage}
  {lineage}
  {subset}
  {assay}
  {assay_full}
  {lab}
  {rbc}
  {table_date}
  {number_of_antigens}
  {number_of_sera}
  {number_of_layers}


* Drawing

line, arrow, rectangle, circle
http://geomalgorithms.com/a03-_inclusion.html

#+BEGIN_SRC json
  {"N": "path", "points": [<point-position>, ...], "close": true, "outline_width": 1, "outline": "red", "fill": "transparent",
   "arrows": [{"at": <point-index>, "from": <point-index>, "width": 5, "outline": "magenta", "outline_width": 1, "fill": "magenta"}]},
  {"N": "circle", "center": <point-position>, "radius": 1, "aspect": 1.0, "rotation": 0, "fill": "#80FFA500", "outline": "#80FF0000", "outline_width": 10}

  -- point-position
  {"v": [x, y]} -- viewport based, top left corner of viewport is 0,0  WARNING: works only after setting the viewport!
  {"l": [x, y]} -- x,y without map transformation
  {"t": [x, y]} -- map transformation will be applied to x,y
  {"a": {<antigen-select>}} -- if multiple antigens selected, middle point of them used
  {"s": {<serum-select>}} -- if multiple antigens selected, middle point of them used

  {"N": "connection_lines", "antigens": {<select>}, "sera": {<select>}, "color": "grey", "line_width": 0.5, "report": false},
  {"N": "error_lines", "antigens": {<select>}, "sera": {<select>}, "more": "red", "less": "blue", "line_width": 0.5, "report": false},

  # {"N": "serum_line", "color": "red", "line_width": 1},
  # {"N": "color_by_number_of_connection_lines", "antigens": {<select>}, "sera": {<select>}, "start": "", "end": ""},
  # {"N": "blobs", "select": {<select-antigens>}, "stress_diff": 0.5, "number_of_drections": 36, "stress_diff_precision": 1e-5, "fill": "transparent", "color": "pink", "line_width": 1, "report": false},
#+END_SRC


* Whole map manipulation



* Move

#+BEGIN_SRC json
  {"N": "move", "antigens": {<antigen-select>}, "sera": {<serum-select>}, "report": true,
   "to": <point-position>, "?relative": [1, 1],
   "flip-over-line": [<point-position>, <point-position>],
   "flip-over-serum-line": 1 -- scale (1 - mirror, 0.1 - close to serum line, 0 - move to serum line)
  }

  # {"N": "move_antigens_stress", "select": {"reference": true}, "?to": [5, 5], "?relative": [1, 1], "?fill": "pink", "?outline": "grey", "?order": "raise", "?size": 1, "report": true},
#+END_SRC


* Serum Circles

#+BEGIN_SRC json
  {"N": "serum_circle", "serum": {<Select Sera>}, "?antigen": {<Select Antigens>}, "?homologous_titer": "1280",
   "report": true, "verbose": false,
   "?fold": 2.0, "? fold": "2 - 4fold, 3 - 8fold",
   "empirical":   {"fill":  "<color-modifier>", "outline": "<color-modifier>", "outline_width": 2, "?outline_dash": "dash2", "?angles": [0, 30], "?radius_line": {"dash": "dash2", "color": "<color-modifier>", "line_width": 1}},
   "theoretical": {"fill":  "<color-modifier>", "outline": "<color-modifier>", "outline_width": 2, "?outline_dash": "dash2", "?angles": [0, 30], "?radius_line": {"dash": "dash2", "color": "<color-modifier>", "line_width": 1}},
   "fallback":    {"fill":  "<color-modifier>", "outline": "<color-modifier>", "outline_width": 2, "outline_dash": "dash3",  "?angles": [0, 30], "?radius_line": {"dash": "dash2", "color": "<color-modifier>", "line_width": 1}},
   "mark_serum":   {"fill": "<color-modifier>", "outline": "<color-modifier>", "order": "raise", "label": {"format": "{full_name}", "offset": [0, 1.2], "color": "black", "size": 12}},
   "mark_antigen": {"fill": "<color-modifier>", "outline": "<color-modifier>", "order": "raise", "label": {"format": "{full_name}", "offset": [0, 1.2], "color": "black", "size": 12}}
  }

  {"N": "serum_coverage", "serum": {<select>}, "?antigen": {<select>}, "?homologous_titer": "1280",
   "report": true,
   "?fold": 2.0, "? fold": "2 - 4fold, 3 - 8fold",
   "within_4fold": {"outline": "pink", "outline_width": 3, "order": "raise"},
   "outside_4fold": {"fill": "grey50", "outline": "black", "order": "raise"},
   "mark_serum": <see serum_circle>,
  }
#+END_SRC


* Procrustes

#+BEGIN_SRC json
{"N": "procrustes-arrows", "report": true, "verbose": false,
   "chart": <filename or index>, "projection": 0,
   "match": "auto", -- "auto", "strict", "relaxed", "ignored"
   "scaling": false,
   "antigens": "<select-antigens>", "sera": "<select-sera>", -- use "antigens": "none" to use just sera, if "antigens" absent, all are matched
   "threshold": 0.005, -- do not show arrows shorter than this value in units
   "arrow": {"line_width": 1, "outline": "black", "head": {"width": 5, "outline": "black", "outline_width": 1, "fill": "black"}}
  }
#+END_SRC


* TODO break



* TODO export

#+BEGIN_SRC json

{"N": "pdf", "filename": "", "open": false}

#+END_SRC

* TODO relax

* TODO compare sequences

* TODO compare with previous

* TODO Time series

#+BEGIN_SRC json

#+END_SRC


* TODO VCM SSM
:PROPERTIES:
:VISIBILITY: folded
:END:

#+BEGIN_SRC json
# {"N": "title", "background": "transparent", "border_width": 0, "text_size": 24, "font_weight": "bold", "display_name": ["CDC H3 HI March 2017"]},
# "continents",
# {"N": "antigens", "select": "reference", "outline": "grey80", "fill": "transparent"},
# {"N": "antigens", "select": "test", "show": false},
# {"N": "antigens", "select": {"test": true, "date_range": ["2017-03-01", "2017-04-01"]}, "size": 8, "order": "raise", "show": true},
# {"N": "vaccines", "size": 25, "report": false},
# {"N": "point_scale", "scale": 2.5, "outline_scale": 1},
# {"N": "viewport", "rel": [6.5, 7.5, -11]},
#+END_SRC


* Built-in ~/AD/share/conf/mapi.json

#+BEGIN_SRC json
  "/all-grey"
  "/size-reset"
  "/egg"
  "/clades"
  "//clades" -- reset size, all grey, egg, /clades
  "/clades-pale"
  "/clades-6m"
  "/clades-12m"
  "/continents"
#+END_SRC


* Rest
:PROPERTIES:
:VISIBILITY: folded
:END:

"==================== sequences ====================",

{"N": "amino-acids", "pos": [159], "?colors": {"K": "#FF0000", "R": "#0000FF", "X": "grey25"},
 "color_set": "ana|google", "outline": "black", "outline_width": 1.0,
 "aspect": 1.0, "rotation": 0.0, "size": 8.0, "order": "raise|lower",
 "legend": {"count": true},
 "centroid": false,
 "report": false},

{"N": "compare-sequences",
 "select1": {"?": "master group select"}, "select2": {"?": "to compare group select"},
 "format": "text|html", "output": "filename.html - if has no /, generated in the same dir as output pdf", "open": true
},

"==================== ====================",

{obsolete! "N": "serum_circle", "serum": {"index": 0}, "?antigen": {"index": 0}, "?homologous_titer": "1280", "report": true,
 "type": "empirical (default) | theoretical",
 "circle": {"fill": "#C08080FF", "outline": "blue", "outline_width": 2, "angle_degrees": [0, 30], "radius_line_dash": "dash2", "?radius_line_color": "red", "?radius_line_width": 1},
 "mark_serum": {"fill": "lightblue", "outline": "black", "order": "raise", "label": {"name_type": "full", "offset": [0, 1.2], "color": "black", "size": 12}},
 "mark_antigen": {"fill": "lightblue", "outline": "black", "order": "raise", "label": {"name_type": "full", "offset": [0, 1.2], "color": "black", "size": 12}}},


* COMMENT ====== local vars
:PROPERTIES:
:VISIBILITY: folded
:END:
#+STARTUP: showall indent
Local Variables:
eval: (auto-fill-mode 0)
eval: (add-hook 'before-save-hook 'time-stamp)
eval: (set (make-local-variable org-confirm-elisp-link-function) nil)
End:
